import { expect, test } from '@oclif/test';
import { tmpdir } from 'node:os';

import { CondenseHelper } from '../../../../src/helpers/data/condense/index';
import { mkdtempSync } from 'node:fs';
import { sep } from 'node:path';

/* Set of tests evaluates the data condense functionality to ensure mappings do not break. 
   If a new collection is added, the collections var below should be updated to contain outputs from the v0_0_25 and v1_0_0 files contained in the test/data folder which serve as benchmarks.
*/
describe('Data Condense Helper', async () => {
  const date = new Date();
  const formattedDate = `${date.getFullYear()}${
    date.getMonth() < 9 ? '0' : ''
  }${date.getMonth() + 1}${date.getDate() < 10 ? '0' : ''}${date.getDate()}`;
  const testingOutputDir = mkdtempSync(`${tmpdir()}${sep}`);
  console.log(testingOutputDir);
  const testingInputDir = 'test/data/';
  const collections: Record<
    string,
    Record<string, string | boolean | number | null | undefined>[]
  > = {
    default: [
      {
        domain: 'aas.gsa.gov',
        url: 'https://aas.gsa.gov/',
        scanDate: '20230402',
        scanVersion: '0.0.25',
        scanStatus: 'Page loaded successfully',
        pmHsts: true,
        pmDap: true,
        pmContact: true,
        pmBanner: true,
        pmIdentifier: true,
        pmIdentifierAccessibility: true,
        pmIdentifierFOIA: true,
        pmIdentifierPrivacy: true,
        pmSearch: true,
        siteScannerScanDate: '2023-04-02T02:00:05.101Z',
        siteScannerUSWDSClasses: 45,
        siteScannerUSWDSSemVer: 'v3.1.0',
        siteScannerUSWDSAccordion: false,
        siteScannerUSWDSAlert: false,
        siteScannerUSWDSButton: true,
        siteScannerUSWDSCard: false,
        siteScannerUSWDSFooter: true,
        siteScannerUSWDSHeader: true,
        'lighthouse.desktopData.lhr.categories.performance.score': 0.69,
        "lighthouse.desktopData.lhr.audits['speed-index'].score": 0.92,
        "lighthouse.desktopData.lhr.audits['content-width'].score": 1,
        'lighthouse.desktopData.lhr.categories.seo.score': 0.79,
        'lighthouse.mobileData.lhr.categories.performance.score': 0.68,
        "lighthouse.mobileData.lhr.audits['speed-index'].score": 0.88,
        "lighthouse.mobileData.lhr.audits['content-width'].score": 1,
        'lighthouse.mobileData.lhr.categories.seo.score': 0.79,
        "lighthouse.desktopData.lhr.audits['meta-viewport'].score": 1,
        "lighthouse.desktopData.lhr.audits['meta-description'].score": 1,
        "lighthouse.desktopData.lhr.audits['document-title'].score": 1,
        "lighthouse.desktopData.lhr.audits['html-has-lang'].score": 1,
      },
      {
        domain: 'digital.gov',
        url: 'https://digital.gov/',
        scanDate: '20230414',
        scanVersion: '1.0.0',
        scanStatus: 'Page loaded successfully',
        pmHsts: true,
        pmDap: true,
        pmContact: true,
        pmBanner: true,
        pmIdentifier: true,
        pmIdentifierAccessibility: true,
        pmIdentifierFOIA: true,
        pmIdentifierPrivacy: true,
        pmSearch: true,
        siteScannerScanDate: '2023-04-14T14:20:36.329Z',
        siteScannerUSWDSClasses: 55,
        siteScannerUSWDSSemVer: null,
        siteScannerUSWDSAccordion: false,
        siteScannerUSWDSAlert: false,
        siteScannerUSWDSButton: true,
        siteScannerUSWDSCard: false,
        siteScannerUSWDSFooter: true,
        siteScannerUSWDSHeader: true,
        'lighthouse.desktopData.lhr.categories.performance.score': 1,
        "lighthouse.desktopData.lhr.audits['speed-index'].score": 1,
        "lighthouse.desktopData.lhr.audits['content-width'].score": 1,
        'lighthouse.desktopData.lhr.categories.seo.score': 1,
        'lighthouse.mobileData.lhr.categories.performance.score': 1,
        "lighthouse.mobileData.lhr.audits['speed-index'].score": 1,
        "lighthouse.mobileData.lhr.audits['content-width'].score": 1,
        'lighthouse.mobileData.lhr.categories.seo.score': 1,
        "lighthouse.desktopData.lhr.audits['meta-viewport'].score": 1,
        "lighthouse.desktopData.lhr.audits['meta-description'].score": 1,
        "lighthouse.desktopData.lhr.audits['document-title'].score": 1,
        "lighthouse.desktopData.lhr.audits['html-has-lang'].score": 1,
      },
    ],
    gearScans: [
      {
        domain: 'aas.gsa.gov',
        scanDate: '20230402',
        scanVersion: '0.0.25',
        screenshotDesktopImgPath:
          'data/scans/20230402/aas.gsa.gov_desktop_dfeb91c7d1f3b6eaa7b6e5e3700f5b17.png',
        screenshotMobileImgPath:
          'data/scans/20230402/aas.gsa.gov_mobile_5257a78d453257d05f9c676c12974e74.png',
      },
      {
        domain: 'digital.gov',
        scanDate: '20230414',
        scanVersion: '1.0.0',
        screenshotDesktopImgPath:
          'data/scans/20230414/digital.gov_desktop_4cb002e75997cd5fe3b6396536d62cee.png',
        screenshotMobileImgPath:
          'data/scans/20230414/digital.gov_mobile_88913717276325a88d6325cbfa9d0bde.png',
      },
    ],
    lighthouseAccessibility: [
      {
        domain: 'aas.gsa.gov',
        url: 'https://aas.gsa.gov/',
        scanDate: '20230402',
        scanVersion: '0.0.25',
        scanStatus: 'Page loaded successfully',
        pmHsts: true,
        pmDap: true,
        pmContact: true,
        pmBanner: true,
        pmIdentifier: true,
        pmIdentifierAccessibility: true,
        pmIdentifierFOIA: true,
        pmIdentifierPrivacy: true,
        pmSearch: true,
        siteScannerScanDate: undefined,
        siteScannerUSWDSClasses: undefined,
        siteScannerUSWDSSemVer: undefined,
        siteScannerUSWDSAccordion: false,
        siteScannerUSWDSAlert: false,
        siteScannerUSWDSButton: true,
        siteScannerUSWDSCard: false,
        siteScannerUSWDSFooter: true,
        siteScannerUSWDSHeader: true,
        'lighthouse.desktopData.lhr.categories.performance.score': 0.69,
        "lighthouse.desktopData.lhr.audits['speed-index'].score": 0.92,
        "lighthouse.desktopData.lhr.audits['content-width'].score": 1,
        'lighthouse.desktopData.lhr.categories.seo.score': 0.79,
        'lighthouse.mobileData.lhr.categories.performance.score': undefined,
        "lighthouse.mobileData.lhr.audits['speed-index'].score": 0.88,
        "lighthouse.mobileData.lhr.audits['content-width'].score": 1,
        'lighthouse.mobileData.lhr.categories.seo.score': undefined,
        "lighthouse.desktopData.lhr.audits['meta-viewport'].score": 1,
        "lighthouse.desktopData.lhr.audits['meta-description'].score": 1,
        "lighthouse.desktopData.lhr.audits['document-title'].score": 1,
        "lighthouse.desktopData.lhr.audits['html-has-lang'].score": 1,
        "lighthouse.desktopData.lhr.audits['aria-allowed-attr'].score": 1,
        "lighthouse.desktopData.lhr.audits['aria-hidden-body'].score": 1,
        "lighthouse.desktopData.lhr.audits['aria-hidden-focus'].score": 1,
        "lighthouse.desktopData.lhr.audits['aria-required-attr'].score": 1,
        "lighthouse.desktopData.lhr.audits['aria-roles'].score": 1,
        "lighthouse.desktopData.lhr.audits['aria-valid-attr-value'].score": 1,
        "lighthouse.desktopData.lhr.audits['aria-valid-attr'].score": 1,
        "lighthouse.desktopData.lhr.audits['button-name'].score": 1,
        "lighthouse.desktopData.lhr.audits['bypass'].score": 1,
        "lighthouse.desktopData.lhr.audits['color-contrast'].score": 1,
        "lighthouse.desktopData.lhr.audits['duplicate-id-aria'].score": 1,
        "lighthouse.desktopData.lhr.audits['heading-order'].score": 0,
        "lighthouse.desktopData.lhr.audits['html-lang-valid'].score": 1,
        "lighthouse.desktopData.lhr.audits['image-alt'].score": 1,
        "lighthouse.desktopData.lhr.audits['link-name'].score": 1,
        "lighthouse.desktopData.lhr.audits['list'].score": 1,
        "lighthouse.desktopData.lhr.audits['listitem'].score": 1,
      },
      {
        domain: 'digital.gov',
        url: 'https://digital.gov/',
        scanDate: '20230414',
        scanVersion: '1.0.0',
        scanStatus: 'Page loaded successfully',
        pmHsts: true,
        pmDap: true,
        pmContact: true,
        pmBanner: true,
        pmIdentifier: true,
        pmIdentifierAccessibility: true,
        pmIdentifierFOIA: true,
        pmIdentifierPrivacy: true,
        pmSearch: true,
        siteScannerScanDate: '2023-04-14T14:20:36.329Z',
        siteScannerUSWDSClasses: 55,
        siteScannerUSWDSSemVer: null,
        siteScannerUSWDSAccordion: false,
        siteScannerUSWDSAlert: false,
        siteScannerUSWDSButton: true,
        siteScannerUSWDSCard: false,
        siteScannerUSWDSFooter: true,
        siteScannerUSWDSHeader: true,
        'lighthouse.desktopData.lhr.categories.performance.score': 1,
        "lighthouse.desktopData.lhr.audits['speed-index'].score": 1,
        "lighthouse.desktopData.lhr.audits['content-width'].score": 1,
        'lighthouse.desktopData.lhr.categories.seo.score': 1,
        'lighthouse.mobileData.lhr.categories.performance.score': 1,
        "lighthouse.mobileData.lhr.audits['speed-index'].score": 1,
        "lighthouse.mobileData.lhr.audits['content-width'].score": 1,
        'lighthouse.mobileData.lhr.categories.seo.score': 1,
        "lighthouse.desktopData.lhr.audits['meta-viewport'].score": 1,
        "lighthouse.desktopData.lhr.audits['meta-description'].score": 1,
        "lighthouse.desktopData.lhr.audits['document-title'].score": 1,
        "lighthouse.desktopData.lhr.audits['html-has-lang'].score": 1,
        "lighthouse.desktopData.lhr.audits['aria-allowed-attr'].score": 1,
        "lighthouse.desktopData.lhr.audits['aria-hidden-body'].score": 1,
        "lighthouse.desktopData.lhr.audits['aria-hidden-focus'].score": 1,
        "lighthouse.desktopData.lhr.audits['aria-required-attr'].score": 1,
        "lighthouse.desktopData.lhr.audits['aria-roles'].score": 1,
        "lighthouse.desktopData.lhr.audits['aria-valid-attr-value'].score": 1,
        "lighthouse.desktopData.lhr.audits['aria-valid-attr'].score": 1,
        "lighthouse.desktopData.lhr.audits['button-name'].score": 1,
        "lighthouse.desktopData.lhr.audits['bypass'].score": 1,
        "lighthouse.desktopData.lhr.audits['color-contrast'].score": 1,
        "lighthouse.desktopData.lhr.audits['duplicate-id-aria'].score": 1,
        "lighthouse.desktopData.lhr.audits['heading-order'].score": 1,
        "lighthouse.desktopData.lhr.audits['html-lang-valid'].score": 1,
        "lighthouse.desktopData.lhr.audits['image-alt'].score": 1,
        "lighthouse.desktopData.lhr.audits['link-name'].score": 1,
        "lighthouse.desktopData.lhr.audits['list'].score": 1,
        "lighthouse.desktopData.lhr.audits['listitem'].score": 1,
      },
    ],
    uswds: [
      {
        domain: 'aas.gsa.gov',
        url: 'https://aas.gsa.gov/',
        scanDate: '20230402',
        scanVersion: '0.0.25',
        scanStatus: 'Page loaded successfully',
        uswdsComponentsAccordion: false,
        uswdsComponentsAlert: false,
        uswdsComponentsBanner: true,
        uswdsComponentsBreadcrumb: false,
        uswdsComponentsButton: true,
        uswdsComponentsButtonGroup: false,
        uswdsComponentsCard: false,
        uswdsComponentsCharacterCount: false,
        uswdsComponentsCheckbox: false,
        uswdsComponentsCollection: false,
        uswdsComponentsComboBox: false,
        uswdsComponentsDateInput: false,
        uswdsComponentsDatePicker: false,
        uswdsComponentsDateRangePicker: false,
        uswdsComponentsDropdown: false,
        uswdsComponentsFileInput: false,
        uswdsComponentsFooter: true,
        uswdsComponentsForm: false,
        uswdsComponentsGrid: true,
        uswdsComponentsHeader: true,
        uswdsComponentsIcon: true,
        uswdsComponentsIconList: false,
        uswdsComponentsIdentifier: true,
        uswdsComponentsInputPrefix: false,
        uswdsComponentsInputSuffix: false,
        uswdsComponentsLink: true,
        uswdsComponentsList: false,
        uswdsComponentsModal: false,
        uswdsComponentsPagination: false,
        uswdsComponentsProcessList: false,
        uswdsComponentsProse: false,
        uswdsComponentsRadioButton: false,
        uswdsComponentsRangeSlider: false,
        uswdsComponentsSearch: true,
        uswdsComponentsSideNav: false,
        uswdsComponentsSiteAlert: false,
        uswdsComponentsStepIndicator: false,
        uswdsComponentsSummaryBox: false,
        uswdsComponentsTable: false,
        uswdsComponentsTag: false,
        uswdsComponentsTextInput: true,
        uswdsComponentsTimePicker: false,
        uswdsComponentsTooltip: false,
        uswdsComponentsValidation: false,
      },
      {
        domain: 'digital.gov',
        url: 'https://digital.gov/',
        scanDate: '20230414',
        scanVersion: '1.0.0',
        scanStatus: 'Page loaded successfully',
        uswdsComponentsAccordion: false,
        uswdsComponentsAlert: false,
        uswdsComponentsBanner: true,
        uswdsComponentsBreadcrumb: false,
        uswdsComponentsButton: true,
        uswdsComponentsButtonGroup: false,
        uswdsComponentsCard: false,
        uswdsComponentsCharacterCount: false,
        uswdsComponentsCheckbox: false,
        uswdsComponentsCollection: false,
        uswdsComponentsComboBox: false,
        uswdsComponentsDateInput: false,
        uswdsComponentsDatePicker: false,
        uswdsComponentsDateRangePicker: false,
        uswdsComponentsDropdown: false,
        uswdsComponentsFileInput: false,
        uswdsComponentsFooter: true,
        uswdsComponentsForm: false,
        uswdsComponentsGrid: true,
        uswdsComponentsHeader: true,
        uswdsComponentsIcon: true,
        uswdsComponentsIconList: false,
        uswdsComponentsIdentifier: true,
        uswdsComponentsInputPrefix: false,
        uswdsComponentsInputSuffix: false,
        uswdsComponentsLink: true,
        uswdsComponentsList: true,
        uswdsComponentsModal: false,
        uswdsComponentsPagination: false,
        uswdsComponentsProcessList: false,
        uswdsComponentsProse: false,
        uswdsComponentsRadioButton: false,
        uswdsComponentsRangeSlider: false,
        uswdsComponentsSearch: true,
        uswdsComponentsSideNav: false,
        uswdsComponentsSiteAlert: false,
        uswdsComponentsStepIndicator: false,
        uswdsComponentsSummaryBox: false,
        uswdsComponentsTable: false,
        uswdsComponentsTag: false,
        uswdsComponentsTextInput: true,
        uswdsComponentsTimePicker: false,
        uswdsComponentsTooltip: false,
        uswdsComponentsValidation: false,
      },
    ],
  };

  for (const key in collections) {
    if (Object.prototype.hasOwnProperty.call(collections, key)) {
      test.it(
        `${key} Collection processes pre/post v1.0.0 scan data properly`,
        async () => {
          const condenseHelper = new CondenseHelper(formattedDate, {
            output: testingOutputDir,
            collection: key,
            folders: '',
          });
          await condenseHelper.findFiles(testingInputDir);
          const extractData = await Promise.all(
            condenseHelper.fileParsePromiseArray,
          ).then((values) => {
            return condenseHelper.extractDataPoints(values);
          });

          expect(extractData).to.deep.equal(collections[key]);
        },
      );
    }
  }

  after(async () => {
    // const promisesArray: Promise<any>[] = [];
    // const dataDir = `${__dirname}/../../../../data/scans/${formattedDate}`;
    // const dir = await opendir(dataDir);
    // for await (const file of dir) {
    //   if (file.name.startsWith('testsite.html_')) {
    //     promisesArray.push(rm(`${dataDir}/${file.name}`));
    //   }
    // }
    // return Promise.all(promisesArray);
  });
});
